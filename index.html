<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMU Guideline Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .active-nav {
      transition: background-color 0.2s, color 0.2s;
    }
    .active-nav.active {
      background-color: #e0f2fe;
      color: #1e40af;
    }
  </style>
</head>
<body class="h-screen flex bg-gray-100">
  <div class="flex flex-col w-64 bg-white border-r">
    <div class="h-16 flex items-center px-6 text-xl font-bold text-blue-900 border-b">IMU 導覽</div>
    <nav class="flex-1 overflow-y-auto p-4 space-y-4" id="sidebar-nav">Loading...</nav>
  </div>

  <div class="flex-1 flex flex-col">
    <header id="breadcrumb-header" class="bg-white px-6 py-3 shadow">
      <nav class="flex text-sm text-gray-500 space-x-2">
        <a href="#" class="hover:underline">首頁</a>
        <span>/</span>
        <span id="breadcrumb-current" class="text-gray-700 font-semibold">歡迎</span>
      </nav>
    </header>
    <main class="flex-1 overflow-auto">
      <div id="notion-viewer" class="p-6 space-y-4 overflow-auto h-full">
        <iframe src="https://imu-framework.notion.site/20fbce068710803db8efdbc6b7c21e50" class="w-full h-full border-none"></iframe>
      </div>
    </main>
  </div>

  <script>
    const NOTION_DB_URL = "/api/notion.js";

    async function fetchSidebarData() {
      const res = await fetch(NOTION_DB_URL);
      if (!res.ok) throw new Error("載入失敗");
      return res.json();
    }

    function updateBreadcrumb(path) {
      const breadcrumb = document.getElementById('breadcrumb-current');
      breadcrumb.innerHTML = path.map(p => `<span class="text-gray-700 font-semibold">${p}</span>`).join(' / ');
    }

    function clearOutline() {
      document.querySelectorAll('.outline-nav').forEach(o => o.remove());
    }

    function loadPage(e, url) {
      const container = document.getElementById('notion-viewer');
      container.innerHTML = `<iframe src="${url}" class="w-full h-full border-none"></iframe>`;
    }

    async function initSidebar() {
      const sidebar = document.getElementById('sidebar-nav');
      sidebar.innerHTML = '';
      try {
        const { pages } = await fetchSidebarData();

        const parents = pages.filter(p => p.Active && !p.Parent);
        const children = pages.filter(p => p.Active && p.Parent);

        parents.forEach(parent => {
          const details = document.createElement('details');
          details.classList.add('group');

          const summary = document.createElement('summary');
          summary.className = 'flex items-center justify-between cursor-pointer px-3 py-2 text-base font-semibold text-gray-800 hover:bg-blue-50 rounded-lg';
          summary.innerHTML = `<span class="flex items-center">${parent.Title}</span><svg class="w-5 h-5 transform group-open:rotate-90 transition duration-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>`;

          const ul = document.createElement('ul');
          ul.className = 'ml-8 mt-2 space-y-1 text-base';
          const relatedChildren = children.filter(c => c.Parent === parent.Title);

          relatedChildren.forEach(item => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.textContent = item.Title;
            a.className = 'flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-800 rounded-lg cursor-pointer transition-colors duration-200 active-nav';
            a.onclick = e => {
              e.stopPropagation();
              clearOutline();
              document.querySelectorAll('.active-nav').forEach(link => link.classList.remove('active'));
              a.classList.add('active');
              updateBreadcrumb([parent.Title, item.Title]);
              const viewMode = item.View_Mode?.toLowerCase() || 'page';
              const url = viewMode === 'db'
                ? `db-view.html?dbId=${item.Page_ID}`
                : `page-view.html?pageId=${item.Page_ID}`;
              window.location.href = url;
            };
            li.appendChild(a);
            ul.appendChild(li);
          });

          details.appendChild(summary);
          details.appendChild(ul);
          sidebar.appendChild(details);
        });
      } catch (err) {
        sidebar.innerHTML = '❌ 無法載入資料';
        console.error(err);
      }
    }

    initSidebar();
  </script>
</body>
</html>
