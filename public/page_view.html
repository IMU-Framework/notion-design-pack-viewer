<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notion Page Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-800">
  <!-- Fixed Header -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-white px-4 sm:px-6 py-3 shadow-sm border-b backdrop-blur-sm bg-white/95">
    <nav class="flex justify-between items-center text-sm text-gray-500" id="breadcrumb-bar">
      <div id="breadcrumb-nav" class="flex items-center space-x-2 min-w-0 flex-1"></div>
      <div id="last-edited-time" class="hidden md:block text-xs text-gray-400 ml-4 whitespace-nowrap cursor-pointer hover:text-blue-700 transition-colors flex-shrink-0"></div>
    </nav>
  </header>

  <!-- Main Content with responsive top padding -->
  <main class="max-w-4xl mx-auto px-4 sm:px-6 pt-16 md:pt-20 pb-8">
    <article id="notion-content" class="space-y-4">
      <!-- åˆå§‹è¼‰å…¥å‹•ç•« -->
    </article>
  </main>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let currentPageId = urlParams.get('pageId');

    const loadingHTML = `
      <div class="animate-pulse">
        <div class="h-6 bg-gray-200 rounded w-3/4 mb-4"></div>
        <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
      </div>
    `;

    // æª¢æ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿè£ç½®
    function isMobile() {
      return window.innerWidth < 768; // md breakpoint
    }

    async function loadPageContentById(pageId) {
      if (!pageId) {
        console.error("PageId is required");
        return;
      }

      const contentElement = document.getElementById('notion-content');
      if (!contentElement) {
        console.error("Content element not found");
        return;
      }

      contentElement.innerHTML = loadingHTML;

      try {
        const response = await fetch(`/api/page?pageId=${pageId}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ç„¡æ³•å–å¾—é é¢å…§å®¹`);
        }

        const data = await response.json();
        if (!data) {
          throw new Error("å›æ‡‰è³‡æ–™ç‚ºç©º");
        }

        // âœ… æ›´æ–° breadcrumb nav - éŸ¿æ‡‰å¼é¡¯ç¤º
        const breadcrumb = document.getElementById("breadcrumb-nav");
        if (breadcrumb) {
          breadcrumb.innerHTML = '';

          // ğŸ”§ æ‰‹æ©Ÿç‰ˆä¸é¡¯ç¤º databaseTitleï¼Œæ¡Œé¢ç‰ˆé¡¯ç¤º
          const items = [];
          if (!isMobile() && data.databaseTitle) {
            items.push(data.databaseTitle);
          }
          if (data.group) {
            items.push(data.group);
          }
          items.push(data.title || 'æœªå‘½åé é¢');
          
          items.forEach((text, idx) => {
            if (idx > 0) {
              const sep = document.createElement("span");
              sep.textContent = "/";
              sep.className = "text-gray-400 mx-1 flex-shrink-0";
              breadcrumb.appendChild(sep);
            }
            const span = document.createElement("span");
            span.textContent = text;
            span.className = idx === items.length - 1 
              ? "text-gray-700 font-semibold truncate" 
              : "text-gray-500 hover:text-gray-700 truncate";
            breadcrumb.appendChild(span);
          });
        }

        // æ›´æ–° last edited time (åƒ…åœ¨æ¡Œé¢ç‰ˆé¡¯ç¤º)
        const lastEditedElement = document.getElementById("last-edited-time");
        if (lastEditedElement && data.lastEdited) {
          try {
            const d = new Date(data.lastEdited);
            if (!isNaN(d.getTime())) {
              const dateStr = d.toLocaleDateString("sv-SE");
              const timeStr = d.toLocaleTimeString("en-GB", { hour: '2-digit', minute: '2-digit' });
              lastEditedElement.textContent = `Last edited: ${dateStr} ${timeStr} âŸ³`;
            }
          } catch (dateError) {
            console.warn("æ—¥æœŸæ ¼å¼éŒ¯èª¤:", dateError);
          }
        }

        if (window.renderBlocks && typeof window.renderBlocks === 'function') {
          const htmlContent = await window.renderBlocks(data.blocks || []);
          if (Array.isArray(htmlContent)) {
            contentElement.innerHTML = htmlContent.join('');
            enhanceInternalLinks();
          } else {
            throw new Error("renderBlocks å›å‚³æ ¼å¼éŒ¯èª¤");
          }
        } else {
          contentElement.innerHTML = '<div class="text-red-600">âš ï¸ renderBlocks å‡½æ•¸æœªè¼‰å…¥æˆ–ä¸å¯ç”¨</div>';
        }
      } catch (error) {
        console.error("è¼‰å…¥å¤±æ•—:", error);
        contentElement.innerHTML = `
          <div class="text-red-600 p-4 border border-red-300 rounded bg-red-50">
            <h3 class="font-bold text-lg mb-2">âš ï¸ è¼‰å…¥å¤±æ•—</h3>
            <p>${error.message}</p>
            <button onclick="loadPageContentById('${pageId}')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              é‡è©¦
            </button>
          </div>
        `;
      }
    }

    function enhanceInternalLinks() {
      const links = document.querySelectorAll('#notion-content a[href]');
      links.forEach(link => {
        const href = link.getAttribute('href');
        if (href) {
          const isInternalPageId = /^\/?[0-9a-f]{32}$/.test(href);
          if (isInternalPageId) {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              const pageId = href.replace(/^\//, '');
              if (pageId && pageId !== currentPageId) {
                const newUrl = `${window.location.pathname}?pageId=${pageId}`;
                window.history.pushState({ pageId }, '', newUrl);
                currentPageId = pageId;
                loadPageContentById(pageId);
              }
            });
          }
        }
      });
    }

    async function loadInitialPageContent() {
      const contentElement = document.getElementById('notion-content');
      if (!contentElement) {
        console.error("Content element not found");
        return;
      }

      if (!currentPageId || currentPageId === "null" || currentPageId === "undefined") {
        contentElement.innerHTML = `
          <div class="text-red-600 p-4 border border-red-300 rounded bg-red-50">
            <h3 class="font-bold text-lg mb-2">âš ï¸ ç„¡æ•ˆçš„ Page ID</h3>
            <p>ç„¡æ³•è¼‰å…¥é é¢å…§å®¹ï¼Œè«‹ç¢ºèª Page ID æ˜¯å¦æ­£ç¢ºã€‚</p>
            <p class="mt-2 text-sm">ç•¶å‰ Page ID: ${currentPageId ? `"${currentPageId}"` : 'æœªæä¾›'}</p>
            <button onclick="window.history.back()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              è¿”å›ä¸Šä¸€é 
            </button>
          </div>
        `;
        return;
      }

      contentElement.innerHTML = loadingHTML;

      if (typeof window.renderBlocks === 'undefined') {
        const script = document.createElement('script');
        script.src = '/assets/renderBlocks.js';
        script.onload = () => {
          console.log("renderBlocks.js loaded successfully");
          loadPageContentById(currentPageId);
        };
        script.onerror = (error) => {
          console.error("Failed to load renderBlocks.js:", error);
          contentElement.innerHTML = `
            <div class="text-red-600 p-4 border border-red-300 rounded bg-red-50">
              <h3 class="font-bold text-lg mb-2">âš ï¸ è…³æœ¬è¼‰å…¥å¤±æ•—</h3>
              <p>ç„¡æ³•è¼‰å…¥ renderBlocks.js</p>
              <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                é‡æ–°å˜—è©¦
              </button>
            </div>
          `;
        };
        document.body.appendChild(script);
      } else {
        loadPageContentById(currentPageId);
      }
    }

    // è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°æ¸²æŸ“ breadcrumb
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (currentPageId) {
          // åªæ›´æ–° breadcrumbï¼Œä¸é‡æ–°è¼‰å…¥æ•´å€‹é é¢
          const breadcrumb = document.getElementById("breadcrumb-nav");
          if (breadcrumb && breadcrumb.children.length > 0) {
            loadPageContentById(currentPageId);
          }
        }
      }, 250);
    });

    window.addEventListener('DOMContentLoaded', loadInitialPageContent);

    window.addEventListener('popstate', (event) => {
      if (event.state?.pageId && event.state.pageId !== currentPageId) {
        currentPageId = event.state.pageId;
        loadPageContentById(currentPageId);
      }
    });

    // âœ… åŠ å…¥ Refresh æŒ‰éˆ•åŠŸèƒ½ - åŠ ä¸Šå®‰å…¨æª¢æŸ¥
    const lastEditedElement = document.getElementById("last-edited-time");
    if (lastEditedElement) {
      lastEditedElement.onclick = async () => {
        if (!currentPageId) return;
        try {
          await fetch(`/api/page?pageId=${currentPageId}&clear=true`);
          loadPageContentById(currentPageId);
        } catch (err) {
          console.error("ğŸ” Reload failed", err);
        }
      };
    }

  </script>
</body>
</html>
